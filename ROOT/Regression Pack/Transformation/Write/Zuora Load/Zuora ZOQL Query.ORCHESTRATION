{"job":{"components":{"6204":{"id":6204,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-378,"y":-146,"width":32,"height":32,"inputConnectorIDs":[6214],"outputSuccessConnectorIDs":[6215],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Run the Query"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nimport time\nimport json\nimport boto3\nimport base64\n\nheaders={\"accepts\":\"application/json\", \"Content-Type\":\"application/json\"}\nkmsclient = boto3.client('kms')\npwd=kmsclient.decrypt(CiphertextBlob=base64.b64decode(enc_password))['Plaintext']\nauth=(username, pwd)\n\njob_defn = {\n  \"format\": \"csv\",\n  \"version\": \"1.1\",\n  \"name\": \"Example\",\n  \"encrypted\": \"none\",\n  \"datetimeUtc\": \"true\",\n  \"queries\" : [{\n      \"name\": \"Query1\",\n      \"query\": ZOQL_Query,\n      \"type\": \"zoqlexport\"\n  }]\n}\n\n# Submit a new job and extract the id\nresponse = requests.post('{}/apps/api/batch-query/'.format(Zuora_URL), data=json.dumps(job_defn), \n                         auth=auth, headers=headers)\nresponse.raise_for_status()\nid = response.json().get(\"id\")\n\n# Await completion for a bit\nstarted = time.time()\nwhile True:\n  if (time.time()-started) > max_wait_seconds:\n    raise Exception('Got bored waiting for the response to reach \"completed\" status after {} seconds'.format(max_wait_seconds))\n\n  response = requests.get('{}/apps/api/batch-query/jobs/{}'.format(Zuora_URL, id), auth=auth,\n                         headers=headers)\n  response.raise_for_status()\n  status = response.json().get(\"status\")\n\n  if status==\"completed\":\n    break\n  else:\n    print \"Waiting for Query Completion...\"\n    time.sleep(3)\n\nfileid = response.json().get(\"batches\")[0].get(\"fileId\")\n\n# Put results into variables ready for the next component\nURL = \"{}/apps/api/file/{}\".format(Zuora_URL, fileid)\n\ncontext.updateVariable('_Zuora_file_URL', URL)\ncontext.updateVariable('_dec_pass', pwd)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"60"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6205":{"id":6205,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":764755612,"x":-226,"y":-151,"width":32,"height":32,"inputConnectorIDs":[6215],"outputSuccessConnectorIDs":[6216],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get Query Result File to S3"}}}},"visible":true},"2":{"slot":2,"name":"Input Data Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"HTTPS"}}}},"visible":true},"3":{"slot":3,"name":"Set Home Directory as Root","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false},"4":{"slot":4,"name":"Input Data URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${_Zuora_file_URL}"}}}},"visible":true},"5":{"slot":5,"name":"Output Object Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"loadfile.csv"}}}},"visible":true},"6":{"slot":6,"name":"Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${username}"}}}},"visible":true},"7":{"slot":7,"name":"Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${_dec_pass}"}}}},"visible":true},"8":{"slot":8,"name":"SFTP Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"9":{"slot":9,"name":"S3 Path","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${S3_Bucket}"}}}},"visible":true},"10":{"slot":10,"name":"Gzip S3 Data","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"11":{"slot":11,"name":"Unpack ZIP file","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"12":{"slot":12,"name":"Domain","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"13":{"slot":13,"name":"Input Data URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"s3://<bucket>/<path>"}}}},"visible":false},"14":{"slot":14,"name":"Input Data URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"gs://<bucket>/<path>"}}}},"visible":false},"15":{"slot":15,"name":"Perform Certificate Validation","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6206":{"id":6206,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-729,"y":-143,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6217],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6207":{"id":6207,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":1611478312,"x":-560,"y":-144,"width":32,"height":32,"inputConnectorIDs":[6217],"outputSuccessConnectorIDs":[6214],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Recreate Target Table"}}}},"visible":true},"2":{"slot":2,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"3":{"slot":3,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"4":{"slot":4,"name":"New Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${output_table}"}}}},"visible":true},"5":{"slot":5,"name":"Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"id"},"2":{"slot":2,"type":"STRING","value":"VARCHAR"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"balance"},"2":{"slot":2,"type":"STRING","value":"FLOAT"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"createdDate"},"2":{"slot":2,"type":"STRING","value":"TIMESTAMP"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"LastInvoiceDate"},"2":{"slot":2,"type":"STRING","value":"DATE"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"BillCycleDay"},"2":{"slot":2,"type":"STRING","value":"FLOAT"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"InvoiceTemplateId"},"2":{"slot":2,"type":"STRING","value":"VARCHAR"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"AllowInvoiceEdit"},"2":{"slot":2,"type":"STRING","value":"BOOLEAN"},"3":{"slot":3,"type":"INTEGER","value":""},"4":{"slot":4,"type":"INTEGER","value":""},"5":{"slot":5,"type":"STRING","value":""},"6":{"slot":6,"type":"STRING","value":"No"},"7":{"slot":7,"type":"STRING","value":"No"}}}},"visible":true},"6":{"slot":6,"name":"Create/Replace","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Replace"}}}},"visible":true},"7":{"slot":7,"name":"Clustering Keys","elements":{},"visible":true},"8":{"slot":8,"name":"Data Retention Time in Days","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":true},"9":{"slot":9,"name":"Comment","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"11":{"slot":11,"name":"Primary Keys","elements":{},"visible":true},"12":{"slot":12,"name":"Table Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Permanent"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6208":{"id":6208,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":-67,"y":-139,"width":32,"height":32,"inputConnectorIDs":[6216],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Load 0"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${S3_Bucket}"}}}},"visible":true},"5":{"slot":5,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"6":{"slot":6,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"8":{"slot":8,"name":"Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${output_table}"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{},"visible":true},"10":{"slot":10,"name":"Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"11":{"slot":11,"name":"File Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CSV"}}}},"visible":true},"12":{"slot":12,"name":"Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AUTO"}}}},"visible":true},"20":{"slot":20,"name":"Record Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR","value":""}}}},"visible":true},"21":{"slot":21,"name":"Field Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR","value":""}}}},"visible":true},"22":{"slot":22,"name":"Skip Header","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"1"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"25":{"slot":25,"name":"Timestamp Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"YYYY-MM-DDTHH24:MI:SSTZHTZM"}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR","value":""}}}},"visible":true},"28":{"slot":28,"name":"Escape Unenclosed Field","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR","value":""}}}},"visible":true},"29":{"slot":29,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"30":{"slot":30,"name":"Field Optionally Enclosed","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR","value":""}}}},"visible":true},"31":{"slot":31,"name":"Null If","elements":{},"visible":true},"32":{"slot":32,"name":"Error On Column Count Mismatch","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"33":{"slot":33,"name":"Empty Field as Null","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"True"}}}},"visible":true},"34":{"slot":34,"name":"Encoding Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"40":{"slot":40,"name":"Enable Octal","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"41":{"slot":41,"name":"Allow Duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"42":{"slot":42,"name":"Strip Outer Array","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"43":{"slot":43,"name":"Strip Null Values","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"44":{"slot":44,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"60":{"slot":60,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"61":{"slot":61,"name":"Preserve Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"62":{"slot":62,"name":"Strip Outer Element","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"63":{"slot":63,"name":"Disable Snowflake Data","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"64":{"slot":64,"name":"Disable Auto Convert","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"120":{"slot":120,"name":"On Error","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Abort Statement"}}}},"visible":true},"121":{"slot":121,"name":"n","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":false},"122":{"slot":122,"name":"Size Limit (B)","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":true},"123":{"slot":123,"name":"Purge S3 Files","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"124":{"slot":124,"name":"Truncate Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"125":{"slot":125,"name":"Force Load","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"140":{"slot":140,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"141":{"slot":141,"name":"Master Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"142":{"slot":142,"name":"KMS Key Id","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"200":{"slot":200,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"201":{"slot":201,"name":"Pattern","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"loadfile.csv"}}}},"visible":true},"203":{"slot":203,"name":"Metadata Fields","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6209":{"id":6209,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-551,"y":58,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Run the Query"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nimport time\nimport json\nimport boto3\nimport base64\n\nheaders={\"Content-Type\":\"application/json\"}\nauth=(username, pwd)\n\njob_defn = {\n    \"Format\": \"csv\", \n    \"Name\": \"test_Export_1476935164447\", \n    \"Query\": \"select * from account\"\n}\n\nresponse = requests.post('https://rest.apisandbox.zuora.com/v1/object/export', data=json.dumps(job_defn), \n                         auth=auth, headers=headers)\nprint response.json()\nid = response.json().get(\"id\")\nprint id\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"60"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6210":{"id":6210,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-408,"y":82,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Run the Query (1)"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nimport time\nimport json\nimport boto3\nimport base64\n\nheaders={\"Content-Type\":\"application/json\"}\nkmsclient = boto3.client('kms')\npwd=kmsclient.decrypt(CiphertextBlob=base64.b64decode(enc_password))['Plaintext']\nauth=(username, pwd)\n\njob_defn = {\n    \"Format\": \"csv\", \n    \"Name\": \"test_Export_1476935164447\", \n    \"Query\": \"select * from account\"\n}\n\n# Submit a new job and extract the id\nresponse = requests.post('https://rest.apisandbox.zuora.com/v1/object/export'.format(Zuora_URL), data=json.dumps(job_defn), \n                         auth=auth, headers=headers)\nresponse.raise_for_status()\nid = response.json().get(\"Id\")\n\n# Await completion for a bit\nstarted = time.time()\nwhile True:\n  if (time.time()-started) > max_wait_seconds:\n    raise Exception('Got bored waiting for the response to reach \"completed\" status after {} seconds'.format(max_wait_seconds))\n\n  response = requests.get('{}/apps/api/batch-query/jobs/{}'.format(Zuora_URL, id), auth=auth,\n                         headers=headers)\n  response.raise_for_status()\n  status = response.json().get(\"status\")\n  print status\n\n  if status==\"completed\":\n    break\n  else:\n    print \"Waiting for Query Completion...\"\n    time.sleep(3)\n\nfileid = response.json().get(\"batches\")[0].get(\"fileId\")\n\n# Put results into variables ready for the next component\nURL = \"{}/apps/api/file/{}\".format(Zuora_URL, fileid)\n\ncontext.updateVariable('_Zuora_file_URL', URL)\ncontext.updateVariable('_dec_pass', pwd)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"60"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6211":{"id":6211,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":1611478312,"x":-544,"y":-23,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Recreate Target Table"}}}},"visible":true},"2":{"slot":2,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"3":{"slot":3,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"4":{"slot":4,"name":"New Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${output_table}"}}}},"visible":true},"5":{"slot":5,"name":"Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"GRID","value":"table_metadata"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"GRID","value":"name"},"2":{"slot":2,"type":"GRID","value":"type"},"3":{"slot":3,"type":"GRID","value":"size"},"4":{"slot":4,"type":"GRID","value":"precision"},"5":{"slot":5,"type":"GRID","value":null},"6":{"slot":6,"type":"GRID","value":null},"7":{"slot":7,"type":"GRID","value":null}}}},"visible":true},"6":{"slot":6,"name":"Create/Replace","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Replace"}}}},"visible":true},"7":{"slot":7,"name":"Clustering Keys","elements":{},"visible":true},"8":{"slot":8,"name":"Data Retention Time in Days","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":true},"9":{"slot":9,"name":"Comment","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"11":{"slot":11,"name":"Primary Keys","elements":{},"visible":true},"12":{"slot":12,"name":"Table Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Permanent"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6212":{"id":6212,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-508,"y":-281,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Script 0"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${sf_query}"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6213":{"id":6213,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":1519899023,"x":-885,"y":35,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"adv_account_zoo"}}}},"visible":true},"2":{"slot":2,"name":"Basic/Advanced Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Basic"}}}},"visible":true},"3":{"slot":3,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"6":{"slot":6,"name":"Data Source","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Account"}}}},"visible":true},"7":{"slot":7,"name":"Data Selection","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AccountNumber"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"AdditionalEmailAddresses"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"AllowInvoiceEdit"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"AutoPay"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"Balance"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"Batch"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"BcdSettingOption"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"BillCycleDay"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"BillToId"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"CommunicationProfileId"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"CreatedById"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"CreatedDate"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"CreditBalance"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"CrmId"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"Currency"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"CustomerServiceRepName"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"DefaultPaymentMethodId"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"Id"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"InvoiceDeliveryPrefsEmail"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"InvoiceDeliveryPrefsPrint"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"InvoiceTemplateId"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"LastInvoiceDate"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"Mrr"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"Name"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"Notes"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"ParentId"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"PaymentGateway"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"PaymentTerm"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"PurchaseOrderNumber"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"SalesRepName"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"SoldToId"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"Status"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"TaxCompanyCode"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptCertificateID"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptCertificateType"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptDescription"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptEffectiveDate"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptExpirationDate"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptIssuingJurisdiction"}}},"40":{"slot":40,"values":{"1":{"slot":1,"type":"STRING","value":"TaxExemptStatus"}}},"41":{"slot":41,"values":{"1":{"slot":1,"type":"STRING","value":"TotalInvoiceBalance"}}},"42":{"slot":42,"values":{"1":{"slot":1,"type":"STRING","value":"UnappliedBalance"}}},"43":{"slot":43,"values":{"1":{"slot":1,"type":"STRING","value":"UpdatedById"}}},"44":{"slot":44,"values":{"1":{"slot":1,"type":"STRING","value":"UpdatedDate"}}},"45":{"slot":45,"values":{"1":{"slot":1,"type":"STRING","value":"VATId"}}}},"visible":true},"8":{"slot":8,"name":"Data Source Filter","elements":{},"visible":true},"9":{"slot":9,"name":"Combine Filters","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true},"10":{"slot":10,"name":"ZOQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select id, Balance, CreatedDate, LastInvoiceDate, BillCycleDay, InvoiceTemplateId, AllowInvoiceEdit from Account"}}}},"visible":false},"11":{"slot":11,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"12":{"slot":12,"name":"Connection Options","elements":{},"visible":true},"13":{"slot":13,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"14":{"slot":14,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"15":{"slot":15,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"adv_account_zoo"}}}},"visible":true},"16":{"slot":16,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"17":{"slot":17,"name":"S3 Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"mtlnbulkload"}}}},"visible":true},"102":{"slot":102,"name":"Endpoint","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"https://rest.apisandbox.zuora.com"}}}},"visible":true},"103":{"slot":103,"name":"Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ed.thompson@matillion.com"}}}},"visible":true},"104":{"slot":104,"name":"Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"M4tillion01!"}}}},"visible":true},"105":{"slot":105,"name":"Entity ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"1001":{"slot":1001,"name":"","elements":{},"visible":false},"1015":{"slot":1015,"name":"Authentication Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"User/Password"}}}},"visible":true},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"40501":{"slot":40501,"name":"Load Options","elements":{},"visible":true},"88340":{"slot":88340,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":false},"88341":{"slot":88341,"name":"Staging","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Existing Amazon S3 Location"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6214":{"id":6214,"sourceID":6207,"targetID":6204},"6215":{"id":6215,"sourceID":6204,"targetID":6205},"6216":{"id":6216,"sourceID":6205,"targetID":6208}},"failureConnectors":{},"unconditionalConnectors":{"6217":{"id":6217,"sourceID":6206,"targetID":6207}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"S3_Bucket":{"definition":{"name":"S3_Bucket","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"s3://mtlnbulkload/"},"ZOQL_Query":{"definition":{"name":"ZOQL_Query","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"select id, name, updateddate, createdbyid, description, effectiveenddate from Product"},"Zuora_URL":{"definition":{"name":"Zuora_URL","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"https://apisandbox.zuora.com"},"_Zuora_file_URL":{"definition":{"name":"_Zuora_file_URL","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"empty"},"_dec_pass":{"definition":{"name":"_dec_pass","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"empty"},"enc_password":{"definition":{"name":"enc_password","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"AQECAHg+GylJSUf4DDePt5tdYU5K/SBuMmi5+Ho+Cwqoym7hBgAAAGowaAYJKoZIhvcNAQcGoFswWQIBADBUBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDAulDqFIxEpuouiwOgIBEIAnySprK35egIq+nsemkaFll3yvWVsDu0wVmrP+IYLhdQoMCO3gMSX2"},"max_wait_seconds":{"definition":{"name":"max_wait_seconds","type":"DECIMAL","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"60"},"output_table":{"definition":{"name":"output_table","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"zuora_output"},"username":{"definition":{"name":"username","type":"TEXT","scope":"BRANCH","description":null,"visibility":"PUBLIC"},"value":"ed.thompson@matillion.com"}},"grids":{"table_metadata":{"definition":{"name":"table_metadata","scope":"BRANCH","definitions":[{"name":"name","type":"TEXT"},{"name":"type","type":"TEXT"},{"name":"size","type":"DECIMAL"},{"name":"precision","type":"DECIMAL"}],"description":null,"visibility":"PUBLIC"},"values":[{"values":["id","VARCHAR","50","0"]},{"values":["name","VARCHAR","200","0"]},{"values":["updateddate","TIMESTAMP","50","0"]},{"values":["createdbyid","VARCHAR","50","0"]},{"values":["description","VARCHAR","2000","0"]},{"values":["effectiveenddate","DATE","4","0"]}]}}},"info":{"name":"Zuora ZOQL Query","description":"","type":"ORCHESTRATION","tag":"b386e867-c620-4fc1-9ce9-9ccaf551243a"}}